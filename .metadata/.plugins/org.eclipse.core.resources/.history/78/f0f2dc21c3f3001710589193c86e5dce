package com.locdata.Legal.TaxPrep;

import java.io.IOException;
import java.io.InputStream;
import java.io.InputStreamReader;
import java.net.HttpURLConnection;
import java.net.URL;
import java.util.Iterator;

import org.apache.poi.EncryptedDocumentException;
import org.apache.poi.openxml4j.exceptions.InvalidFormatException;
import org.apache.poi.ss.usermodel.Cell;
import org.apache.poi.ss.usermodel.CellType;
import org.apache.poi.ss.usermodel.Row;

import com.google.gson.JsonArray;
import com.google.gson.JsonElement;
import com.google.gson.JsonObject;
import com.google.gson.JsonParser;
import com.locdata.ingest.excel.ExcelReader;

//H & R Block Canada

// API - https://www.hrblock.ca/wp-admin/admin-ajax.php?lang=en&action=store_search&lat=53.52200970000001&lng=-113.52878670000001&max_results=1000&radius=200

public class LegalTax_HRBlockCanada_LocData {
	
	// All Postal Zip Codes of Canada  ca_postal_codes.xls

	 private static final String FILE_NAME = "./temp/ca_postal_codes.xls";
	 
	 public static void main(String args[]) throws EncryptedDocumentException, InvalidFormatException, IOException, InterruptedException{
		 
		 int sheetNumber = 0;
		 
		 Iterator<Row> iterator = ExcelReader.excelRead(FILE_NAME, sheetNumber);
		 
		 if(iterator == null) System.exit(0);
		 
		 while (iterator.hasNext()) {

	         Row currentRow = iterator.next();
	         Iterator<Cell> cellIterator = currentRow.iterator();
	         double latitude = 0;
	         double longitude = 0;
	         while (cellIterator.hasNext()) {

	             Cell currentCell = cellIterator.next();
	             
	             if (currentCell.getCellTypeEnum() == CellType.NUMERIC) {
	            	 
	            	 if(currentCell.getColumnIndex() == 3){
	            		// System.out.println(" latitude ---> " + currentCell.getNumericCellValue());
	            		 latitude = currentCell.getNumericCellValue();
	            	 }
	            	 if(currentCell.getColumnIndex() == 4){
	            		// System.out.println(" longitude -------> "+ currentCell.getNumericCellValue());
	            		 longitude = currentCell.getNumericCellValue();
	            	 }
	             }
	         }
	         if(latitude != 0.0 && longitude != 0.0){
	        	 
	        	 String sURL = "https://www.hrblock.ca/wp-admin/admin-ajax.php?lang=en&action=store_search&lat="+latitude+"&lng="+longitude+"&max_results=20&radius=100";
		         System.out.println(" URL  " + sURL);
		         URL url = new URL(sURL);
		         HttpURLConnection request = (HttpURLConnection) url.openConnection();
		         request.setReadTimeout(100000);
		         request.connect();
		         if(request.getContent() != null){
		        	  JsonParser jp = new JsonParser(); //from gson
				         JsonElement root = jp.parse(new InputStreamReader((InputStream) request.getContent())); //Convert the input stream to a json element

				         if (root instanceof JsonArray) {
					        	 System.out.println(" Inside Array here ---> ");

				        	    JsonArray  jarray =  root.getAsJsonArray();
				        	    for (Object o : jarray) {
				        	        JsonObject jsonLineItem = (JsonObject) o;
				        	        JsonElement address = jsonLineItem.get("address");
				        	        JsonElement store = jsonLineItem.get("store");
				        	        JsonElement phone = jsonLineItem.get("phone");
				        	        
				        	        System.out.println(" Address =======> " + address.toString());
				        	        System.out.println(" Store =======> " + store.toString());
				        	        System.out.println(" Store =======> " + store.toString());

				        	    }

				        	   
				        	 }
		         }
		       
	         }
		 }
	 }
}